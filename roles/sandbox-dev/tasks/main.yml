---
- name: Install JetBrains IDE backend dependencies
  become: true
  ansible.builtin.package:
    name:
      - default-jre
      - openssh-server

      # Headless rendering dependencies
      - libxrender1
      - libxtst6
      - libxi6
      - fontconfig
      - git

      # Process utilities
      - procps
      - lsof
    state: present

- name: Create dev user
  become: true
  ansible.builtin.user:
    name: "{{ sandbox_dev_user }}"
    shell: /bin/zsh
    create_home: true
    groups: "{{ sandbox_dev_groups }}"
  when: sandbox_dev_create_user

- name: Ensure SSH host keys exist
  become: true
  ansible.builtin.command:
    cmd: ssh-keygen -A
    creates: /etc/ssh/ssh_host_rsa_key

- name: Configure SSH
  become: true
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
    - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
    - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }

- name: Create .ssh directory for dev user
  become: true
  ansible.builtin.file:
    path: "/home/{{ sandbox_dev_user }}/.ssh"
    state: directory
    owner: "{{ sandbox_dev_user }}"
    group: "{{ sandbox_dev_user }}"
    mode: '0700'
  when: sandbox_dev_create_user
